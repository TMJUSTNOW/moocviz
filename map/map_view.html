<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>World Map</title>
<style>
body {
  font:"Palatino Linotype", serif;
}

select, option {
  font-size: 13pt;
  font:"Palatino Linotype", serif;
}

#top{
  float:left;  
  margin:0 0 10px 5%;
  width:50%;
}

#key, #other, #info {
  float:left;
  margin-top: 10px;
  padding:10px;
  border: 2px solid #ccc;
  clear:left;
  width:280px;
}
#legend {
  float:right;
  background: #fff;
  width:320px;
  margin-bottom:20px;
}
#legend div.box {
  clear:both;
  margin-right:10px;
  width:15px;
  height:15px;
  float:left;
  border: 1px solid #999;
}
#legend label {
  width: 250px;
  float:left;
}

h2{
  font-size: 100%;
  margin:0px;
  clear: both;
}

#container {
  margin:10px;
  padding:10px;
  padding-right:0px;
  clear:both;
}

.country {
  fill:#DCDCDC;
}

.hidden { 
  display: none; 
}
div.tooltip {
  color: #222; 
  background: #fff; 
  padding: 4px; 
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 4px; 
  box-shadow: 0px 0px 2px 0px #a6a6a6; 
  opacity: 0.9; 
  position: absolute;
}

.fill {
  fill: #fff;
}
.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.chart rect {
  fill: steelblue;
}

.chart text {
  fill: white;
  font: 10px sans-serif;
}

</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-941940-28']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>
<body>
  <div id="container">
  <select class="form-control" id="whichinputfile" onchange="refresh()">
    <option>All Courses</option>
    <option>HarvardX CB22x, 2013 Spring</option>
    <option>HarvardX CS50x, 2012</option>
    <option>HarvardX ER22x, 2013 Spring</option>
    <option>HarvardX PH207x, 2012 Fall</option>
    <option>HarvardX PH278x, 2013 Spring</option>
    <option>MITx 14.73x, 2013 Spring</option>
    <option>MITx 2.01x, 2013 Spring</option>
    <option>MITx 3.091x, 2012 Fall</option>
    <option>MITx 3.091x, 2013 Spring</option>
    <option>MITx 6.002x, 2012 Fall</option>
    <option>MITx 6.002x, 2013 Spring</option>
    <option>MITx 6.00x, 2012 Fall</option>
    <option>MITx 6.00x, 2013 Spring</option>
    <option>MITx 7.00x, 2013 Spring</option>
    <option>MITx 8.02x, 2013 Spring</option>
    <option>MITx 8.MReV, 2013 Summer</option>
  </select>
  <select class="form-control" id="whichdatafield" onchange="refresh()">
    <option>Number of students that registered for the course</option>
    <option>Number of students that viewed the course</option>
    <option>Number of students that explored the course content</option>
    <option>Number of students that were certified</option>
    <option>Total number of events</option>
    <option>Total number of days active</option>
    <option>Total number of video plays</option>
    <option>Total number of chapters accessed</option>
    <option>Total number of forum posts</option>
    <option>Probability of viewing the course (decimal)</option>
    <option>Probability of exploring the course content (decimal)</option>
    <option>Probability of becoming certified (decimal)</option>
    <option>Average grade (decimal)</option>
    <option>Average number of events</option>
    <option>Average number of days active</option>
    <option>Average number of video plays</option>
    <option>Average number of chapters accessed</option>
    <option>Average number of forum posts</option>
  </select>
  <input type="checkbox" id="whichscale" onchange="refresh()">Logarithmic Scale</input>
    <div id="legend">
      <div id="key"></div>
      <div id="info"></div>
    </div>
  </div>
  <script src="js/d3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script src="js/d3.geo.projection.v0.min.js"></script>

<script>

var FIELD;
var INPUTFILE;
var LOGSCALED;

var LOGBASE = 10;

var INPUT_FILE_NAMES = {
  "All Courses": "summed_by_country/HMXPC13_DI_v2_5-14-14.csv",
  "HarvardX CB22x, 2013 Spring": "summed_by_country/HarvardX_CB22x_2013_Spring.csv",
  "HarvardX CS50x, 2012": "summed_by_country/HarvardX_CS50x_2012.csv",
  "HarvardX ER22x, 2013 Spring": "summed_by_country/HarvardX_ER22x_2013_Spring.csv",
  "HarvardX PH207x, 2012 Fall": "summed_by_country/HarvardX_PH207x_2012_Fall.csv",
  "HarvardX PH278x, 2013 Spring": "summed_by_country/HarvardX_PH278x_2013_Spring.csv",
  "MITx 14.73x, 2013 Spring": "summed_by_country/MITx_14.73x_2013_Spring.csv",
  "MITx 2.01x, 2013 Spring": "summed_by_country/MITx_2.01x_2013_Spring.csv",
  "MITx 3.091x, 2012 Fall": "summed_by_country/MITx_3.091x_2012_Fall.csv",
  "MITx 3.091x, 2013 Spring": "summed_by_country/MITx_3.091x_2013_Spring.csv",
  "MITx 6.002x, 2012 Fall": "summed_by_country/MITx_6.002x_2012_Fall.csv",
  "MITx 6.002x, 2013 Spring": "summed_by_country/MITx_6.002x_2013_Spring.csv",
  "MITx 6.00x, 2012 Fall": "summed_by_country/MITx_6.00x_2012_Fall.csv",
  "MITx 6.00x, 2013 Spring": "summed_by_country/MITx_6.00x_2013_Spring.csv",
  "MITx 7.00x, 2013 Spring": "summed_by_country/MITx_7.00x_2013_Spring.csv",
  "MITx 8.02x, 2013 Spring": "summed_by_country/MITx_8.02x_2013_Spring.csv",
  "MITx 8.MReV, 2013 Summer": "summed_by_country/MITx_8.MReV_2013_Summer.csv",
};

var DATA_FIELD_NAMES = {
  "Number of students that registered for the course": "registered",
  "Number of students that viewed the course": "viewed",
  "Number of students that explored the course content": "explored",
  "Number of students that were certified": "certified",
  "Total number of events": "nevents",
  "Total number of days active": "ndays_act",
  "Total number of video plays": "nplay_video",
  "Total number of chapters accessed": "nchapters",
  "Total number of forum posts": "nforum_posts",
  "Probability of viewing the course (decimal)": "viewed_avg",
  "Probability of exploring the course content (decimal)": "explored_avg",
  "Probability of becoming certified (decimal)": "certified_avg",
  "Average grade (decimal)": "grade_avg",
  "Average number of events": "nevents_avg",
  "Average number of days active": "ndays_act_avg",
  "Average number of video plays": "nplay_video_avg",
  "Average number of chapters accessed": "nchapters_avg",
  "Average number of forum posts": "nforum_posts_avg",
};

var OTHER_REGIONS = { "Other Europe": ["United Kingdom", "Spain", "Germany", "Poland", "Greece", "Ukraine", "France", "Portugal", "Albania", "Austria", "Romania", "Norway", "Serbia", "Netherlands", "Croatia", "Slovakia", "Slovenia", "Belgium", "Bulgaria", "Bosnia and Herzegovina", "Belarus", "Sweden", "Switzerland", "Ireland", "Estonia", "Iceland", "Italy", "Finland", "Denmark", "Northern Cyprus", "Hungary", "Luxembourg", "Latvia", "Moldova", "Lithuania", "Montenegro", "Kosovo", "Macedonia", "Cyprus", "Czech Republic"], "Other Africa": ["Egypt", "Botswana", "Burkina Faso", "Cote d'Ivoire", "Cameroon", "Eritrea", "The Gambia", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Mali", "Central African Republic", "Libya", "Guinea", "Niger", "Malawi", "Mauritania", "Namibia", "Rwanda", "Sudan", "South Africa", "Zambia", "Zimbabwe", "Somaliland", "Somalia", "South Sudan", "Tanzania", "Uganda", "Senegal", "Western Sahara", "Chad", "Mozambique", "Ghana", "Madagascar", "Tunisia", "Togo", "Sierra Leone", "Swaziland", "Gabon", "Djibouti", "Equatorial Guinea", "Democratic Republic of the Congo", "Algeria", "Republic of the Congo", "Ethiopia", "Burundi", "Benin", "Nigeria", "Angola", "Morocco"], "Other Middle East/Central Asia": ["Armenia", "Georgia", "Azerbaijan", "Kazakhstan", "United Arab Emirates", "Russia", "Pakistan", "Jordan", "Israel", "Lebanon", "Iran", "Iraq", "Palestine", "Syria", "Yemen", "Uzbekistan", "Kyrgyzstan", "Tajikistan", "Turkmenistan", "Turkey", "Kuwait", "Oman", "Qatar", "Saudi Arabia", "Afghanistan"], "Other South Asia": ["Sri Lanka", "Bhutan", "Nepal", "Bangladesh", "Cambodia", "Laos", "Burma", "Thailand", "India"], "Other South America": ["Argentina", "Ecuador", "Chile", "Venezuela", "Paraguay", "Suriname", "Uruguay", "Peru", "Falkland Islands", "Guyana", "Brazil", "Bolivia", "Colombia"], "Other East Asia": ["China", "Vietnam", "Mongolia", "Japan", "North Korea", "South Korea", "Taiwan"], "Other North & Central Amer., Caribbean": ["United States", "Canada", "Haiti", "Guatemala", "Cuba", "Jamaica", "Honduras", "Dominican Republic", "Bahamas", "Belize", "Mexico", "El Salvador", "Nicaragua", "Costa Rica", "Trinidad and Tobago", "Panama", "Puerto Rico"], "Unknown/Other": ["Greenland", "Antarctica", "French Southern and Antarctic Lands"], "Other Oceania": ["Fiji", "Malaysia", "New Caledonia", "Philippines", "Solomon Islands", "New Zealand", "Papua New Guinea", "Brunei", "Australia", "Timor-Leste", "Vanuatu", "Indonesia"]}

var OTHER_LABELS = ["Other South Asia", "Other South America", "Other East Asia", "Other Oceania", "Other Europe", "Other North & Central Amer., Caribbean", "Unknown/Other", "Other Africa", "Other Middle East/Central Asia"];

var OTHER_DATA = {};

var COUNTRY_TO_OTHER = {};
OTHER_LABELS.forEach(function(otherLabel, i) {
  var countrylist = OTHER_REGIONS[otherLabel];
  countrylist.forEach(function(country, i) {
    COUNTRY_TO_OTHER[country] = otherLabel;
  });
});

function refresh() {
  FIELD = DATA_FIELD_NAMES[d3.select("#whichdatafield")[0][0].value];
  INPUTFILE = INPUT_FILE_NAMES[d3.select("#whichinputfile")[0][0].value];
  LOGSCALED = $('#whichscale').prop('checked');
  redraw();
}

var throttleTimer;
function throttle() {
  window.clearTimeout(throttleTimer);
    throttleTimer = window.setTimeout(function() {
      redraw();
    }, 200);
}
function redraw() {
  d3.select('svg').remove();
  document.getElementById('info').innerHTML = "";
  setupMap();
  drawMap(topo);
}
d3.select(window).on("resize", throttle);

//queue
(function(){function n(n){function t(){for(;f=a<c.length&&n>p;){var u=a++,t=c[u],r=l.call(t,1);r.push(e(u)),++p,t[0].apply(null,r)}}function e(n){return function(u,l){--p,null==d&&(null!=u?(d=u,a=s=0/0,r()):(c[n]=l,--s?f||t():r()))}}function r(){null!=d?v(d):i?v(d,c):v.apply(null,[d].concat(c))}var o,f,i,c=[],a=0,p=0,s=0,d=null,v=u;return n||(n=1/0),o={defer:function(){return d||(c.push(arguments),++s,t()),o},await:function(n){return v=n,i=!1,s||r(),o},awaitAll:function(n){return v=n,i=!0,s||r(),o}}}function u(){}"undefined"==typeof module?self.queue=n:module.exports=n,n.version="1.0.4";var l=[].slice})();

var topo, projection, path, svg, g, graticule;
var tooltip = d3.select("body").append("div").attr("class", "tooltip hidden");
setupMap();

function setupMap() {
  var width = document.getElementById('container').offsetWidth - 370;  // subtract px for the legend
  var height = width / 2;
  projection = d3.geo.hammer().translate([0, 0]).scale(width / 2 / Math.PI);
  path = d3.geo.path().projection(projection);
  graticule = d3.geo.graticule();
  svg = d3.select("#container").append("svg")
      .attr("width", width)
      .attr("height", height);
  var outterg = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
  g = outterg.append("g").attr("id", "innerg");
  g.append("defs").append("path")
      .datum({type: "Sphere"})
      .attr("id", "sphere")
      .attr("d", path);
  g.append("use")
      .attr("class", "stroke")
      .attr("xlink:href", "#sphere");
  g.append("use")
      .attr("class", "fill")
      .attr("xlink:href", "#sphere");
  g.append("path")
      .datum(graticule)
      .attr("class", "graticule")
      .attr("d", path);
}

function prettyNum(numString) {
  // numString :: float-string or int-string (e.g. "1342.177")
  // return :: string (e.g. "1,340")
  // Pretty-print a number with commas and 3 sig figs
  var n = parseFloat(numString);
  if (n == 0) return 0;
  return addCommas(reduceSigFigs(n, 3));
}

function reduceSigFigs(n, sig) {
  // n :: float or float-string
  // sig :: int or int-string
  // return :: float-string
  // Reduce the number of sig figs in float n to `sig`
  // Note: n should not have commas
  // Note: n *may* have decimals
  n = parseFloat(n); // just in case
  sig = parseInt(sig);
  var mult = Math.pow(10, sig - Math.floor(Math.log(n) / Math.LN10) - 1);
  var output = Math.round(n * mult) / mult; 
  return uberRound(output, 7); // get rid of silly floatingpoint precision problems
}

function addCommas(numString) {
  // numString :: float-string or int-string or float or int
  // return :: string
  // Add commas to convert e.g. 45123.7 to 45,123.7
  numString += '';   // just in case
  var x = numString.split('.');
  var x1 = x[0];
  var x2 = x.length > 1 ? '.' + x[1] : '';
  var rgx = /(\d+)(\d{3})/;
  while (rgx.test(x1)) {
    x1 = x1.replace(rgx, '$1' + ',' + '$2');
  }
  return x1 + x2;
}

function uberRound(value, precision) {
  var m, f, isHalf, sgn; // helper variables
  // making sure precision is integer
  precision |= 0;
  m = Math.pow(10, precision);
  value *= m;
  // sign of the number
  sgn = (value > 0) | -(value < 0);
  isHalf = value % 1 === 0.5 * sgn;
  f = Math.floor(value);
  if (isHalf) {
    value = f + (sgn > 0);
  }
  return (isHalf ? value : Math.round(value)) / m;
}

function boldBlue(string) {
  return '<span style="color:rgb(30,60,185);"><b>' + string + '</b></span>';
}

function countriesEqual(country_name, smaller_name) {
  // country_name :: string
  // smaller_name :: string
  // Return true if the larger string `country_name` (e.g. "Russian Federation") is equivalent
  // to the sometimes-smaller string `smaller_name` (e.g. "Russia")  UNLESS  Nigeria/Niger is involved
  return country_name == smaller_name || (country_name.indexOf(smaller_name) != -1 && country_name != "Nigeria") ;
}

function drawMap() {
  queue()
      .defer(d3.json, "data/world-110m-cia.json")
      .defer(d3.csv, INPUTFILE)
      .await(ready);

  function ready(error, world, countries) {

    OTHER_LABELS.forEach(function(label, i) {
      OTHER_DATA[label] = 0;
    })
    countries.forEach(function(country, i) {
      if ($.inArray(country.Country, OTHER_LABELS) != -1) {
        OTHER_DATA[country.Country] = country;
      }
    }); //TODO: If an otherlabel is NOT in the countries data -- e.g. Other Oceania is 0 -- this omits it!!

    topo = topojson.feature(world, world.objects.countries).features;

    //update topo with data about the relevant FIELD
    topo.forEach(function(f){
      var cpop = countries.filter(function(a){ return countriesEqual(a.Country, f.properties.name)});
      if(cpop.length>0){
        f.properties.datavalue = parseFloat(cpop[0][FIELD]);
      }
    });

    //sort the arrays in decreasing order of intensity
    topo.sort(function(a, b){
      if (a.properties.datavalue == undefined) a.properties.datavalue = 0;
      if (b.properties.datavalue == undefined) b.properties.datavalue = 0;
      return d3.descending(parseFloat(a.properties.datavalue), parseFloat(b.properties.datavalue)) 
    });
    countries.sort(function(a, b) {
      return d3.descending(parseFloat(a[FIELD]), parseFloat(b[FIELD]));
    });
    OTHER_LABELS.sort(function(a, b) {
      return d3.descending(parseFloat(OTHER_DATA[a][FIELD]), parseFloat(OTHER_DATA[b][FIELD]));
    });

    function logB(num) {
      return Math.log(num) / Math.log(LOGBASE);
    }
    function powB(num) {
      return Math.pow(LOGBASE, num);
    }
    var maximum = topo[0].properties.datavalue * 1.0;
    var log_maximum = logB(maximum + 1);

    function color(num) {
      // Returns a logarithmically-scaled shade of blue.
      // A higher value of num --> a darker blue
      // (more intense colors are FARTHER from 255)

      if (num==0) return "rgb("+MAX+","+MAX+","+MAX+")";

      var R = 15, G = 30, B = 135; // a nice dark blue
      var MAX = 220;
      var DELTA_R = MAX-R, DELTA_G = MAX-G, DELTA_B = MAX-B;
      var percent;
      if (LOGSCALED) {
        percent = logB(num + 1) / log_maximum;
      }
      else {
        percent = num / maximum;
      }
      var r = Math.round(MAX - DELTA_R*percent);
      var g = Math.round(MAX - DELTA_G*percent);
      var b = Math.round(MAX - DELTA_B*percent);
      return "rgb(" + r + "," + g + "," + b + ")";
    }

    var country = d3.select("#innerg").selectAll(".country").data(topo);

    //offsets
    var offsetL = document.getElementById('container').offsetLeft+15;
    var offsetT = document.getElementById('container').offsetTop;

    country.enter().insert("path")
      .attr("class", "country")
      .attr("d", path)
      .attr("id", function(d,i) { return d.id; })
      //.attr("title", function(d,i) { return d.properties.name; })
      .style("fill", function(d,i) { 
        if(d.properties.datavalue !== undefined){
          return color(d.properties.datavalue);         
        } else {
          console.log(d);
        }
      })
      .style("stroke", "#111")
      .on("mousemove", function(d,i) {
        var mouse = d3.mouse(svg.node()).map( function(d) { return parseInt(d); } );

        if (d.properties.datavalue != 0) {        
          var name = d.properties.name;
          var value = d.properties.datavalue;
        } else {
          var name = COUNTRY_TO_OTHER[d.properties.name];
          var c = OTHER_DATA[name];
          var value = c[FIELD];
        }

        tooltip.classed("hidden", false)
          .attr("style", "left:"+(mouse[0]+offsetL)+"px;top:"+(mouse[1]+offsetT)+"px")
          .html(name + ': ' + boldBlue(prettyNum(parseFloat(value))));
      })
      .on("mouseout",  function(d,i) {
        tooltip.classed("hidden", true);
      });

    //create a custom legend
    var legend = '<h2>Legend</h2>';
    var legend_percents = [0, 0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875];
    legend_percents.forEach(function(percent, i) {
      var low_percent = percent;
      var high_percent = percent + 0.125;

      if (LOGSCALED) {
        // percent = Math.log(num + 1) / log_maximum
        var low_value = powB(log_maximum * low_percent) - 1;
        var high_value = powB(log_maximum * high_percent) - 1;
      } else {
        var low_value = low_percent * maximum;
        var high_value = high_percent * maximum;
      }
      var average_value = (low_value + high_value) / 2.0;

      var label = boldBlue(prettyNum(low_value)) + " &ndash; " + boldBlue(prettyNum(high_value));
      legend += '<div class="box" style="background:'+color(average_value)+';"></div><label>'+label+'</label>';
    });

    // create the div about other countries
    var otherCountries = '<h2>Other Regions</h2>';

    OTHER_LABELS.forEach(function(otherLabel, i) {
      country = OTHER_DATA[otherLabel];
      var value = parseFloat(country[FIELD]);
      var label = otherLabel;
      otherCountries += '<div class="box" style="background:'+color(value)+';"></div><label>'+label+': '+boldBlue(prettyNum(value))+'</label>'; 
    });

    $("#other").html(otherCountries);

    //create sorted html table
    /*var table = d3.select("#info").append("table"),
        thead = table.append("thead"),
        tbody = table.append("tbody"),
        theadtr = thead.append("tr");

        theadtr.append("th").text(d3.select("#whichdatafield")[0][0].value);
        theadtr.append("th").text("");*/

    var empty = true;
    var bars = '<h2>'+d3.select("#whichdatafield")[0][0].value+'</h2>';

    topo.forEach(function(c){
      if(c.properties.datavalue !== undefined && c.properties.datavalue > 0){
        
        var name = c.properties.name;
        var value = parseFloat(c.properties.datavalue);
        var label = name + ': ' + boldBlue(prettyNum(value));
        var outof = Math.round(250*value/maximum);
        console.log(outof);
        bars += '<span style="width:'+outof+'; color:black; border:1px solid black;fill:steelblue; font-size:0.'+outof+'pt;">'+label+', '+outof+'</span><br />';
        //TODO: These bars are not working yet :(
        //tbody.append("tr").html('<td>'+c.properties.name+'</td><td>'+boldBlue(prettyNum(parseFloat(c.properties.datavalue)))+'</td>');
        empty = false;
      }
    });
    if (empty) {
      //tbody.append("tr").html('No data.');
      $("#key").html('<h2>Legend</h2>No data.');
      $("#info").html(bars + 'No data.');
    } else{
      $("#key").html(legend);
      $("#info").html(bars)
    }
  }
}

refresh();

</script>
</body>
</html>